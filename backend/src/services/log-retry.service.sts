// src/services/log-retry.service.ts
import { databaseLogService } from "./database-log.service";

export class LogRetryService {
  private retryInterval: NodeJS.Timeout | null = null;
  private readonly RETRY_INTERVAL_MS = 5 * 60 * 1000; // 5 minutos

  /**
   * âœ… Iniciar servicio de reintentos automÃ¡ticos
   */
  iniciarReintentosAutomaticos(): void {
    console.log('ğŸ”„ Iniciando servicio de reintentos de logs...');
    
    this.retryInterval = setInterval(async () => {
      try {
        await databaseLogService.reintentarLogsPendientes();
        
        // Obtener estadÃ­sticas para monitoreo
        const stats = await databaseLogService.obtenerEstadisticasLogs();
        console.log('ğŸ“Š EstadÃ­sticas de logs:', stats);
        
      } catch (error) {
        console.error('âŒ Error en reintento automÃ¡tico:', error);
      }
    }, this.RETRY_INTERVAL_MS);
  }

  /**
   * âœ… Detener servicio de reintentos
   */
  detenerReintentos(): void {
    if (this.retryInterval) {
      clearInterval(this.retryInterval);
      this.retryInterval = null;
      console.log('ğŸ›‘ Servicio de reintentos detenido');
    }
  }

  /**
   * âœ… Reintentar manualmente
   */
  async reintentarManualmente(): Promise<{ success: boolean; message: string }> {
    try {
      await databaseLogService.reintentarLogsPendientes();
      const stats = await databaseLogService.obtenerEstadisticasLogs();
      
      return {
        success: true,
        message: `Reintento manual completado. Pendientes en cachÃ©: ${stats.cache.pendientes}`
      };
    } catch (error) {
      console.error('âŒ Error en reintento manual:', error);
      return {
        success: false,
        message: `Error en reintento manual: ${error}`
      };
    }
  }
}

export const logRetryService = new LogRetryService();